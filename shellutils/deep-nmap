#!/usr/bin/env bash
# ------------------------------------------------------------------------ INFO
# [/shellutils/deep-nmap]
# author        : Pascal Malouin @https://github.com/alterEGO-Linux
# created       : 2025-12-22 02:05:30 UTC
# updated       : 2025-12-28 23:05:38 UTC
# description   : Deep Nmap scan.

[ -n "${__SOURCED_DEEP_NMAP:-}" ] && return
__SOURCED_DEEP_NMAP=1

deep-nmap() {

    # --- ( shell clean up )
    local ARGUMENTS_INPUT=("${@}")
    local BLUE=$'\033[34m'
    local RED=$'\033[31m'
    local RESET=$'\033[0m'

    trap '
        unset -f usage check_applications; trap - RETURN' RETURN

    check_applications() {
        if [[ -n ${__SOURCED_CHECK_APPLICATIONS} ]]; then
            check-applications "${@}"
        else
            for app in $@; do
                if ! command -v $app; then
                    printf '%s\n' "${RED}[!]${RESET} ${app} is not installed."
                    return 1
                fi
            done
        fi
    }
    check_applications cat nmap sudo || return 1

    # --- ( help )
    usage() {
        cat <<EOF
================================================================================
[+] deep-nmap - Deep Nmap scan.
================================================================================
Usage: deep-nmap <Target> [Nmap Options] | [-h|--help]

Runs Nmap as sudo with customizable arguments. Defaults to:
  -sV          - Detect service versions.
  -O           - Enable OS detection.
  -sC          - Run Nmap's default scripts.
  --traceroute - Perform a traceroute to the target.

Options:
  -h, --help    - Display this help message.

Examples:
  deep-nmap 192.168.1.1
  deep-nmap scanme.nmap.org --Pn
================================================================================
EOF
    }

    # --- ( aguments )

    # --- no arguments.
    if [[ $# == 0 ]]; then
        ARGUMENTS_INPUT=("-h")
    fi

    # --- show help and ignore other arguments.
    local i
    for i in "${ARGUMENTS_INPUT[@]}"; do
        if [[ "${i}" == "-h" || "${i}" == "--help" ]]; then
            usage
            return 0
        fi
    done

    if ! command -v grc >/dev/null; then
        sudo nmap -sV -O -sC --traceroute "$@"
    else
        sudo grc nmap -sV -O -sC --traceroute "$@"
    fi

    return 0
}
