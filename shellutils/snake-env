#!/usr/bin/env sh
# ------------------------------------------------------------------------ INFO
# [/.ael/shellutils/snake-env]
# author        : Pascal Malouin @https://github.com/alterEGO-Linux
# created       : 2024-10-23 11:28:49 UTC
# updated       : 2026-01-06 15:00:10 UTC
# description   : Manage python -m venv.

[ -n "${__SOURCED_SNAKE_ENV:-}" ] && return
__SOURCED_SNAKE_ENV=1

snake-env() {

    local __blue=$'\033[34m'
    local __bold=$'\033[1m'
    local __green=$'\033[32m'
    local __red=$'\033[31m'
    local __reset=$'\033[0m'
    local __yellow=$'\033[33m'
    
    export SNAKE_ENV_DIR="${SNAKE_ENV_DIR:-$HOME/.ael/snake-env}"
    export SNAKE_ENV="${SNAKE_ENV}"

    check_applications() {
        if [[ -n ${__SOURCED_CHECK_APPLICATIONS} ]]; then
            check-applications "${@}"
        else
            local app
            for app in $@; do
                if ! command -v $app; then
                    printf '%s\n' "${__red}[!]${__reset} ${app} is not installed."
                    return 1
                fi
            done
        fi
    }
    check_applications python grep xargs find || return 1

    if [ ! -d "${SNAKE_ENV_DIR}" ]; then
        mkdir "${SNAKE_ENV_DIR}"
    fi

    snake_unsetter() {
        unset SNAKE_ENV
        unset SNAKE_ENV_DIR
        unset SNAKE_ENV_ACTIVE
        unset -f snake_activate
        unset -f snake_create
        unset -f list_environments
        unset -f list_all_environments
        unset -f snake-go
        unset -f snake-exit
        unset -f snake-info
        unset -f snake-install-jupyter
        unset -f snake-install-requirements
        unset -f snake-notebook
        unset -f snake-upgrade
        unset -f snake-usage
        unset -f check_applications
        unset -f snake_unsetter
        [ -f ${HOME}/.bashrc ] && . ${HOME}/.bashrc
    }

    snake_activate() {

        if [ ! -d "${SNAKE_ENV_DIR}/${SNAKE_ENV}" ]; then
            printf '%s\n' "${__red}[!]${__reset} Environment ${SNAKE_ENV} does not exists."
            snake_unsetter

        else
            printf '%s\n' "${__blue}[*]${__reset} Starting python environment: ${SNAKE_ENV}."

            if ! grep -q "$(readlink -f $(command -v python))" ${SNAKE_ENV_DIR}/${SNAKE_ENV}/pyvenv.cfg; then
                printf '%s\n' "${__red}[!]${__reset} Outdated environment. Run snake-upgrade."
            fi

            source "${SNAKE_ENV_DIR}/${SNAKE_ENV}/bin/activate"

            # --- [ prompt ]
            prompt_command() {
                history -a
                local date_now="$(date "+%F %H:%M:%S %Z")"

                # --- TTY won't show unicode character #10095.
                if tty | grep pts &>/dev/null; then

                    PS1="\[${__reset}\]\[${__green}\](snake-env: ${SNAKE_ENV})-[\[${__reset}\]\w\[${__green}\]] • \[$date_now\]\n\[${__green}\]❯ \[${__reset}\]"

                else
                    PS1="\[${__reset}\]\[${__green}\](snake-env: ${SNAKE_ENV})-[\[${__reset}\]\w\[${__green}\]] • \[$date_now\]\n\[${__green}\]> \[${__reset}\]"
                fi

                export PS1
            }
            PROMPT_COMMAND=prompt_command

            export SNAKE_ENV_ACTIVE=true
        fi
    }

    snake-go() {
        cd "${SNAKE_ENV_DIR}/${SNAKE_ENV}"
    }

    snake_create() {
        local __new_env="${SNAKE_ENV_DIR}/${SNAKE_ENV}"
        if [ -d "${__new_env}" ]; then
            printf '%s\n' "${__red}[!]${__reset} Snake Environment ${SNAKE_ENV} already exists."
        else
            python -m venv "${__new_env}"
            printf '%s\n' "${__blue}[*]${__reset} Snake Environment ${SNAKE_ENV} created."
        fi
    }

    snake-exit() {
        printf '%s\n' "${__yellow}[!]${__reset} Quitting python environment: ${SNAKE_ENV}."
        deactivate
        snake_unsetter
    }

    snake-info() {

        local __pkgs=()
        while IFS= read -r line; do
            __pkgs+=("$line")
        done < <(pip freeze 2>/dev/null)

        echo "Info: snake-env \"${SNAKE_ENV}\""
        echo "    Env. Path     : ${SNAKE_ENV_DIR}/${SNAKE_ENV}"
        echo "    Python Path   : $(command -v python)"

        if [ "${#__pkgs[@]}" -gt 0 ]; then
            echo "    Installed Pkg : ${__pkgs[0]}"
            for ((i=1; i<${#__pkgs[@]}; i++)); do
                echo "                    ${__pkgs[i]}"
            done
        else
            echo "    Installed Pkg : (none)"
        fi
    }

    snake-install-jupyter() {

        # --- ref. <https://janakiev.com/blog/jupyter-virtual-envs/>

        if [ -n $(command -v jupyter-notebook) ]; then
            if pip freeze | grep -q "ipykernel"; then
                printf '%s\n' "${__yellow}[!]${__reset} Module ipykernel for Jupyter already installed."
            else
                printf '%s\n' "${__blue}[*]${__reset} Installing ipykernel for Jupyter."
                pip install ipykernel
            fi
            python -m ipykernel install --user --name="${SNAKE_ENV}"

            if [[ ! -e "${SNAKE_ENV_DIR}/${SNAKE_ENV}/${SNAKE_ENV}.ipynb" ]]; then
                cat <<EOF > ${SNAKE_ENV_DIR}/${SNAKE_ENV}/${SNAKE_ENV}.ipynb
{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.5"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
EOF
            fi

        else
            printf '%s\n' "${__red}[!]${__reset} Jupyter not installed!"
            check_applications jypyter-notebook || return 1
        fi
    }

    snake-install-requirements() {

        local __requirements="${SNAKE_ENV_DIR}/${SNAKE_ENV}/requirements.txt"
        if [ "${#}" > 0 ]; then
            cp "${1}" "${__requirements}"
            pip install -r "${__requirements}"
        elif [[ -e "${__requirements}" ]]; then
            pip install -r "${__requirements}"
        else
            printf '%s\n' "${__red}[!]${__reset} You must provide a valid requirements file."
        fi
        }

    snake-notebook() {

        check_applications jupyter-notebook || return 1

        if [[ -e "${SNAKE_ENV_DIR}/${SNAKE_ENV}/${SNAKE_ENV}.ipynb" ]]; then
           jupyter-notebook --allow-root "${SNAKE_ENV_DIR}/${SNAKE_ENV}/${SNAKE_ENV}.ipynb" &
        fi
        }

    list_all_environments() {

        printf '%s\n' "${__blue}[*]${__reset} Fetching ALL python environments:"

        local __environments=$(find ~ -type d -name 'bin' -exec test -e '{}/python' ';' -print 2>/dev/null)

        if [[ -n "${__environments}" ]]; then
            echo "${__environments}" | xargs dirname
        else
            echo "(none found)"
        fi
    }

    list_environments() {

        printf '%s\n' "${__blue}[*]${__reset} Fetching python environments"

        local __environments=$(find "${SNAKE_ENV_DIR}" -type d -name 'bin' -exec test -e '{}/python' ';' -print 2>/dev/null)

        if [[ -n "${__environments}" ]]; then
            echo "${__environments}" | xargs dirname | xargs -n1 basename
        else
            echo "(none found)"
        fi
    }

    snake-upgrade() {
        python -m venv --upgrade ${SNAKE_ENV_DIR}/${SNAKE_ENV}
    }

    snake-usage() {
        cat <<EOF
================================================================================
[+] snake-env - Manage python -m venv.
================================================================================
Usage: snake-env [OPTIONS] <environment-name>

A utility to manage Python virtual environments in a custom directory, including setup for Jupyter kernel integration.

Options:
  -c, --create <environment-name>  Create a new Python virtual environment with the specified name and activate it.
  -a, --activate <environment-name> Activate an existing Python virtual environment.
  -l, --list                       List all managed Python virtual environments within the custom directory.
  --listall                        List all Python virtual environments on the system.
  -h, --help                       Display this help message.

Examples:
  snake-env -c myenv               # Create and activate a new environment named 'myenv'
  snake-env -a myenv               # Activate an existing environment named 'myenv'
  snake-env -l                     # List all environments managed by snake-env
  snake-env --listall              # List all Python environments on the system

Internal commands:
  snake-go                         Change directory to the virtual environment.
  snake-exit                       Exit environment.
  snake-info                       Show environment informations.
  snake-install-jupyter            Install Jypiter notebook.
  snake-install-requirements       Install requirements if a valid file is provided.
  snake-notebook                   Launch a Jupyter notebook.
  snake-upgrade                    Upgrade the environment.
  snake-usage                      This help.
================================================================================
EOF
    }

    # --- if already in a snake-env session.
    if [[ ${SNAKE_ENV_ACTIVE} == 'true' ]]; then
        printf '%s\n' "${__red}[!]${__reset} already in a session."
        return 1
    fi

    # --- show help if no arguments.
    if [[ "${#}" -eq 0 ]]; then
        snake-usage
        snake_unsetter
        return 1
    fi

    # --- Show help and ignore other arguments.
    local arg
    for arg in "${@}"; do
        if [[ "${arg}" == "-h" || "${arg}" == "--help" ]]; then
            snake-usage
            snake_unsetter
            return 0
        fi
    done

    # ---------- [ argument parser ]

    # --- Verify if argument-parser exists.
    if [[ ! -n ${__SOURCED_ARGUMENT_PARSER} ]]; then
        printf '%s\n' "${__red}[!]${__reset} Snake-env might not work as intended without alterEGO Linux argument-parser."
        printf '%s\n' "    Available at https://github.com/alterEGO-Linux/ael-files/blob/main/shellutils/utils/argument-parser"
        printf '%s\n' "    Then source it in your .bashrc or .profile, if you are not using alterEGO Linux."
    fi

    local ARGUMENT_INPUT=("${@}")
    declare -A activate=([short]="-a" [long]="--activate" [value_required]=true [conflicts_with]="create")
    declare -A create=([short]="-c" [long]="--create" [value_required]=true [conflicts_with]="activate")
    declare -A directory=([short]="-d" [long]="--directory" [value_required]=true)
    declare -A list=([short]="-l" [long]="--list" [conflicts_with]="create activate listall")
    declare -A listall=([long]="--listall" [conflicts_with]="create activate list")

    local FLAGS=("activate" "create" "directory" "list" "listall")
    local ARGUMENTS=()
    argument-parser

    set -- "${ARGUMENTS[@]}"
    while (( "$#" )); do
        case $1 in
            -a|--activate)
                shift
                SNAKE_ENV="${1}"
                snake_activate
                trap 'unset -f snake_ativate \
                      unset -f snake_create \
                      unset -f list_environments \
                      unset -f list_all_environments; trap - RETURN' RETURN
                ;;
            -c|--create)
                shift
                SNAKE_ENV="${1}"
                snake_create
                snake_unsetter
                ;;
            -d|--directory)
                shift
                SNAKE_ENV_DIR="${1}"
                ;;
            -l|--list)
                list_environments
                snake_unsetter
                ;;
            --listall)
                list_all_environments
                snake_unsetter
                ;;
      esac
      shift
    done
}
